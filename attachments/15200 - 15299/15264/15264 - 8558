@echo off
setlocal enabledelayedexpansion

title GoAgent自动配置工具 v0.9.2
if exist proxy.userbak.ini (goto start) else (goto bakuserini)

:bakuserini
copy /y proxy.user.ini proxy.userbak.ini>nul

:start
cd /d %~dp0
cls
echo.
echo         请选择需要进行的设置：                                   Q,退出
echo.
echo    1,自动代理    2,全局代理     3,停用代理      4,清理临时文件   5,导入证书
echo.
echo    6,配置appid   7,使用公共id   8,上传server端  9,设置开机启动   0,自动更新
echo.
set / choice=      请作出选择:

goto update

:update
cd ..
set / goagent=如您已经下载了官方最新的Goagent包，请将软件包拖放到本窗口并回车；如没有直接回车将自动为您下载当前最新版本：
copy /y "%goagent%"  goagent.zip 1>nul 2>nul

if ERRORLEVEL 1 goto download
if ERRORLEVEL 0 goto 7z


:download
del /f goagent.zip 1>nul 2>nul
set downloaderror=下载失败，请设置DNS为8.8.4.4后重试...
echo.        开始下载当前最新版本Goagent，请稍等......
@path %PATH%;%windir%;%windir%\system32
@netstat -an|find "LISTENING"|find ":8087" && set HTTP_PROXY=http://127.0.0.1:8087 && set HTTPS_PROXY=http://127.0.0.1:8087
@wget.exe -O goagent.zip --no-check-certificate https://nodeload.github.com/goagent/goagent/legacy.zip/3.0 ||echo %downloaderror%  &&pause &&exit

echo.        Goagent下载完成......

:7z
7z.exe x goagent.zip 1>nul 2>nul
@taskkill /f /IM goagent.exe 1>nul 2>nul
@taskkill /f /IM goagent-win8.exe 1>nul 2>nul
@taskkill /f /IM python27.exe 1>nul 2>nul
@taskkill /f /IM python33.exe 1>nul 2>nul

for /f "delims=" %%a in ('dir /b /d goagent-*') do @set pathA=%%~nxa
del /f /s /q "%pathA%"\*.crt
xcopy "%pathA%"\*.* . /s /e /y 1>nul 2>nul
rd /s /q "%pathA%" 1>nul 2>nul

cd /d %~dp0

:set_reg_update
echo	启动http代理
reg add "HKEY_CURRENT_USER\Software\Microsoft\Windows\CurrentVersion\Internet Settings" /v ProxyEnable /t REG_DWORD /d 0 /f 2>nul
reg add "HKEY_CURRENT_USER\Software\Microsoft\Windows\CurrentVersion\Internet Settings" /v AutoConfigURL /d "http://127.0.0.1:8086/proxy.pac" /f 2>nul

echo.

:start01
start "" "goagent.exe" 

:end
exit